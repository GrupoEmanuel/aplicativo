import type { MusicMetadata, NewsItem, AgendaItem, LocationItem } from './drive';
import { CapacitorHttp } from '@capacitor/core';

// GitHub Raw URLs para os arquivos JSON
const GENERAL_JSON_URL = 'https://raw.githubusercontent.com/GrupoEmanuel/aplicativo/refs/heads/main/json/grupo-emanuel-general.json';
const MUSIC_JSON_URL = 'https://raw.githubusercontent.com/GrupoEmanuel/aplicativo/refs/heads/main/json/grupo-emanuel-music.json';

export interface GeneralDatabase {
    news: NewsItem[];
    agenda: AgendaItem[];
    locations: LocationItem[];
    version: number;
    lastUpdated: string;
}

export interface MusicDatabase {
    music: MusicMetadata[];
    version: number;
    lastUpdated: string;
}

export const githubService = {
    /**
     * Check if internet connection is available
     */
    async checkInternetConnection(): Promise<boolean> {
        try {
            const response = await CapacitorHttp.request({
                method: 'HEAD',
                url: 'https://raw.githubusercontent.com'
            });
            console.log('ğŸŒ Connection check:', response.status);
            return response.status >= 200 && response.status < 300;
        } catch (error) {
            console.error('âŒ No internet connection:', error);
            return false;
        }
    },

    /**
     * Fetch general database from GitHub
     * - Always tries GitHub first (primary source)
     * - Cache is updated automatically by AppContext/storageService
     * - Returns null if offline (AppContext will use cached data)
     */
    async fetchGeneralDatabase(): Promise<GeneralDatabase | null> {
        try {
            console.log('ğŸ“¥ Fetching general database from GitHub...');

            const response = await CapacitorHttp.get({ url: GENERAL_JSON_URL });

            if (response.status < 200 || response.status >= 300) {
                throw new Error(`GitHub error: ${response.status}`);
            }

            // Debug: Log the response structure
            console.log('ğŸ“¦ Response data type:', typeof response.data);

            // CapacitorHttp returns data as string if content-type is not set correctly
            let data: GeneralDatabase;
            if (typeof response.data === 'string') {
                data = JSON.parse(response.data);
            } else {
                data = response.data as GeneralDatabase;
            }

            console.log('âœ… GitHub data loaded. Version:', data.lastUpdated);
            console.log('ğŸ“Š News count:', data.news?.length, 'Agenda count:', data.agenda?.length);

            return data;
        } catch (error) {
            console.error('âŒ Failed to fetch from GitHub:', error);
            console.log('ğŸ“‚ Will use cached version (handled by AppContext)');
            return null;
        }
    },

    /**
     * Fetch music database from GitHub
     * - Always tries GitHub first (primary source)
     * - Cache is updated automatically by AppContext/storageService
     * - Returns null if offline (AppContext will use cached data)
     */
    async fetchMusicDatabase(): Promise<MusicDatabase | null> {
        try {
            console.log('ğŸ“¥ Fetching music database from GitHub...');

            const response = await CapacitorHttp.get({ url: MUSIC_JSON_URL });

            if (response.status < 200 || response.status >= 300) {
                throw new Error(`GitHub error: ${response.status}`);
            }

            // Debug: Log the response structure
            console.log('ğŸ“¦ Music response data type:', typeof response.data);

            // CapacitorHttp returns data as string if content-type is not set correctly
            let data: MusicDatabase;
            if (typeof response.data === 'string') {
                data = JSON.parse(response.data);
            } else {
                data = response.data as MusicDatabase;
            }

            console.log('âœ… GitHub data loaded. Version:', data.lastUpdated);
            console.log('ğŸ“Š Music count:', data.music?.length);

            return data;
        } catch (error) {
            console.error('âŒ Failed to fetch from GitHub:', error);
            console.log('ğŸ“‚ Will use cached version (handled by AppContext)');
            return null;
        }
    }
};
